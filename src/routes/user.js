const express = require('express');
const router = express.Router();

//Import user schema
const user = require('../models/user.js');
const settings = require("../models/settings.js");

//user login api
router.post('/login', (req, res) => {
    //find user
    if (user === null) {
        return res.status(400).send({
            message : 'User Not Found.'
        });
    } //End if

    else {
        if (user.validPass(req.body.password)) {
            return res.status(201).send({
                message : 'User Logged In.'
            });
        } //end inner if

        else {
            return res.status(400).send({
                message : 'Wrong Password.'
            });
        } //End inner else
    } //End else
});

//user signup api
router.post('/register', (req, res, next) => {

    const newUser = new user({
        //initialize newUser ID with autogenerated ID
        _id: new mongoose.Types.ObjectId(),
        
        //initialize newUser with request data
        firstName: req.body.firstName,

        lastName: req.body.lastName,

        userName: req.body.userName,

        email: req.body.email,

        password: req.body.password
    });

    //call setPass function to hash password
    newUser.setPass(req.body.password);

    //save the new user to the DB
    newUser.save((err, user) => {
        if (err) {
            return res.status(400).send({
                message : "Failed to add new user"
            });
        } //end if

        else {
            return res.status(201).send({
                message : "User added successfully"
            });
        } //end else
    });

    // Create settings document for the user
    const newSettings = new settings({
        // Link the settings to the user
        userID: newUser._id, 
    });

    newSettings.save((err, settings) => {
        if (err) {
            return res.status(400).send({
                message : "Failed to add new settings"
            });
        } //end if

        else {
            return res.status(201).send({
                message : "Settings added successfully"
            });
        } //end else
    });

});

module.exports = router;